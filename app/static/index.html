<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BusBot - Industrial Network Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 15px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8em;
            color: white;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            color: white;
        }

        /* Network Info Box */
        .network-info-box {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            gap: 20px;
            font-size: 0.85em;
        }

        .network-info-item {
            display: flex;
            flex-direction: column;
        }

        .network-info-label {
            opacity: 0.7;
            font-size: 0.8em;
        }

        .network-info-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* Settings Bar */
        .settings-bar {
            background: #1e2a4a;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-group label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .setting-group input[type="number"],
        .setting-group input[type="text"] {
            background: #2a3a5a;
            border: 1px solid #3a4a6a;
            border-radius: 5px;
            padding: 8px 12px;
            color: white;
            width: 120px;
        }

        .setting-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #3a4a6a;
            border-radius: 13px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #28a745;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #4a5568;
            color: white;
        }

        .btn-secondary:hover {
            background: #3a4558;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Area */
        .progress-area {
            background: #1e2a4a;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            display: none;
        }

        .progress-area.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-phase {
            font-weight: 600;
            color: #667eea;
        }

        .progress-stats {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .progress-bar-container {
            background: #2a3a5a;
            border-radius: 8px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 8px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Device Lists */
        .device-panel {
            background: #1e2a4a;
            border-radius: 10px;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a3a5a;
        }

        .panel-header.network {
            background: linear-gradient(90deg, #607d8b, #455a64);
        }

        .panel-header.bus {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }

        .panel-title {
            font-weight: 600;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-count {
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .device-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }

        .device-item {
            background: #2a3a5a;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .device-item:hover {
            background: #3a4a6a;
            transform: translateX(3px);
        }

        .device-item.bus-device {
            border-left: 3px solid #ff9800;
        }

        .device-ip {
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: #fff;
        }

        .device-details {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 4px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .device-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .device-detail-label {
            opacity: 0.7;
        }

        .protocol-badge {
            background: #667eea;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .protocol-badge.s7comm {
            background: #2196f3;
        }

        .protocol-badge.modbus {
            background: #ff9800;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Config Section */
        /* Config and Note Grid Layout */
        .config-note-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 900px) {
            .config-note-grid {
                grid-template-columns: 1fr;
            }
        }

        .config-section {
            background: #1e2a4a;
            border-radius: 10px;
            padding: 20px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a3a5a;
        }

        .config-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-title.orange {
            color: #ff9800;
        }

        /* Config Form */
        .config-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .config-form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .config-form-group.full-width {
            grid-column: 1 / -1;
        }

        .config-form-group label {
            font-size: 0.85em;
            color: #aaa;
        }

        .config-form-group input,
        .config-form-group select {
            background: #2a3a5a;
            border: 1px solid #3a4a6a;
            border-radius: 5px;
            padding: 10px 12px;
            color: white;
            font-size: 0.95em;
        }

        .config-form-group input:focus,
        .config-form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-form-group input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-section {
            background: #1e2a4a;
            border-radius: 10px;
            padding: 20px;
        }

        .note-field {
            background: #0d1421;
            border: 1px solid #2a3a5a;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            min-height: 200px;
            color: #4caf50;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 300px;
        }

        .config-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* Alert Area */
        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #90caf9;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #a5d6a7;
        }

        .alert-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ef9a9a;
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            color: #ffcc80;
        }

        .hidden { display: none !important; }

        /* Main Layout with Log Panel */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 15px;
        }

        .main-content {
            min-width: 0;
        }

        /* Log Panel */
        .log-panel {
            background: #1e2a4a;
            border-radius: 10px;
            overflow: hidden;
            height: calc(100vh - 50px);
            position: sticky;
            top: 15px;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            background: linear-gradient(90deg, #2196f3, #1976d2);
            padding: 12px 15px;
            font-weight: 600;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-clear-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .log-clear-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }

        .log-entry {
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 4px;
            border-left: 3px solid;
            background: #2a3a5a;
        }

        .log-entry.info {
            border-color: #2196f3;
        }

        .log-entry.success {
            border-color: #4caf50;
        }

        .log-entry.error {
            border-color: #f44336;
        }

        .log-entry.warning {
            border-color: #ff9800;
        }

        .log-time {
            font-size: 0.85em;
            opacity: 0.6;
            margin-bottom: 3px;
        }

        .log-message {
            word-break: break-word;
        }

        @media (max-width: 1200px) {
            .app-layout {
                grid-template-columns: 1fr;
            }
            .log-panel {
                height: 200px;
                position: relative;
                top: 0;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e2a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5a7a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a6a8a;
        }

        /* Checkbox for device selection */
        .device-checkbox {
            margin-right: 10px;
        }

        .btn-configure {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            border: none;
            cursor: pointer;
        }

        .btn-configure:hover {
            background: #43a047;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>ü§ñ BusBot</h1>
                <span class="version-badge">v2.0.1</span>
            </div>
            <div class="network-info-box" id="networkInfo">
                <div class="network-info-item">
                    <span class="network-info-label">IP</span>
                    <span class="network-info-value" id="infoIP">-</span>
                </div>
                <div class="network-info-item">
                    <span class="network-info-label">Maske</span>
                    <span class="network-info-value" id="infoNetmask">-</span>
                </div>
                <div class="network-info-item">
                    <span class="network-info-label">Gateway</span>
                    <span class="network-info-value" id="infoGateway">-</span>
                </div>
                <div class="network-info-item">
                    <span class="network-info-label">DNS</span>
                    <span class="network-info-value" id="infoDNS">-</span>
                </div>
            </div>
        </div>

        <!-- App Layout with Log Panel -->
        <div class="app-layout">
            <div class="main-content">

        <!-- Settings Bar -->
        <div class="settings-bar">
            <div class="setting-group">
                <label>Auto-Scan</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoScanEnabled">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-group">
                <label>Intervall</label>
                <input type="number" id="scanInterval" value="5" min="1" max="60">
                <span style="opacity: 0.7;">Min</span>
            </div>
            <div class="setting-group">
                <label>Netzwerk</label>
                <input type="text" id="networkRange" placeholder="Auto">
            </div>
            <div class="setting-group">
                <label>Ports</label>
                <input type="text" id="portRange" value="102,502,510" style="width: 150px;">
            </div>

            <div style="flex: 1;"></div>

            <button class="btn btn-primary" onclick="startFullScan()" id="btnScan">
                üîç Scan starten
            </button>
            <button class="btn btn-secondary" onclick="stopScan()" id="btnStop" disabled>
                ‚èπÔ∏è Stop
            </button>
        </div>

        <!-- Progress Area -->
        <div class="progress-area" id="progressArea">
            <div class="progress-header">
                <span class="progress-phase" id="progressPhase">Phase 1: Ping-Scan</span>
                <span class="progress-stats">
                    <span id="progressFound">0</span> gefunden
                </span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
            <div class="progress-details">
                <span>IP: <span id="progressIP">-</span></span>
                <span><span id="progressScanned">0</span> / <span id="progressTotal">254</span></span>
                <span>ETA: <span id="progressETA">--:--</span></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Network Devices Panel -->
            <div class="device-panel">
                <div class="panel-header network">
                    <span class="panel-title">üåê Netzwerk-Ger√§te</span>
                    <span class="panel-count" id="networkCount">0</span>
                </div>
                <div class="device-list" id="networkDeviceList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div>Keine Ger√§te gefunden</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">Klicken Sie "Scan starten"</div>
                    </div>
                </div>
            </div>

            <!-- Bus Devices Panel -->
            <div class="device-panel">
                <div class="panel-header bus">
                    <span class="panel-title">üîå Bus-Ger√§te</span>
                    <span class="panel-count" id="busCount">0</span>
                </div>
                <div class="device-list" id="busDeviceList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div>Keine Bus-Ger√§te gefunden</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">Modbus/S7comm Ger√§te erscheinen hier</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration and Note Grid -->
        <div class="config-note-grid">
            <!-- Configuration Section (editable) -->
            <div class="config-section">
                <div class="config-header">
                    <span class="config-title orange">‚öôÔ∏è Konfiguration</span>
                </div>

                <div class="config-form">
                    <div class="config-form-group">
                        <label>Ger√§tename</label>
                        <input type="text" id="cfgName" placeholder="z.B. Wago_PLC_1">
                    </div>
                    <div class="config-form-group">
                        <label>Protokoll</label>
                        <select id="cfgProtocol">
                            <option value="modbus_tcp">Modbus TCP</option>
                            <option value="s7comm">S7comm</option>
                            <option value="profinet">ProfiNet</option>
                        </select>
                    </div>
                    <div class="config-form-group">
                        <label>IP-Adresse</label>
                        <input type="text" id="cfgIP" placeholder="192.168.1.100">
                    </div>
                    <div class="config-form-group">
                        <label>Port</label>
                        <input type="number" id="cfgPort" value="502">
                    </div>
                    <div class="config-form-group">
                        <label>Slave ID</label>
                        <input type="number" id="cfgSlaveId" value="1" min="1" max="247">
                    </div>
                    <div class="config-form-group">
                        <label>Hersteller</label>
                        <input type="text" id="cfgManufacturer" placeholder="z.B. Wago">
                    </div>
                    <div class="config-form-group full-width">
                        <label>Register-Bereich (Start, Anzahl)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="cfgRegStart" placeholder="Start: 0" style="flex: 1;">
                            <input type="number" id="cfgRegCount" placeholder="Anzahl: 10" style="flex: 1;">
                        </div>
                    </div>
                </div>

                <div class="config-buttons">
                    <button class="btn btn-success" onclick="saveDeviceConfig()">
                        üíæ Speichern
                    </button>
                    <button class="btn btn-primary" onclick="generateModbusConfig()" id="btnModbus">
                        üìÑ YAML generieren
                    </button>
                    <button class="btn btn-secondary" onclick="viewConfig()">
                        üëÅÔ∏è Config anzeigen
                    </button>
                </div>
            </div>

            <!-- Note Section (read-only info) -->
            <div class="note-section">
                <div class="config-header">
                    <span class="config-title">üìã Ger√§te-Info</span>
                </div>

                <div class="note-field" id="noteField">Kein Ger√§t ausgew√§hlt.

W√§hlen Sie ein Bus-Ger√§t aus der Liste oben,
um Details anzuzeigen.

Nach der Analyse werden hier angezeigt:
‚Ä¢ Ger√§teinformationen
‚Ä¢ Erkannter Ger√§tetyp
‚Ä¢ Unterst√ºtzte Funktionen
‚Ä¢ Register-Bereiche</div>
            </div>
        </div>

            </div><!-- End main-content -->

            <!-- Log Panel -->
            <div class="log-panel">
                <div class="log-header">
                    <span>üìã Log</span>
                    <button class="log-clear-btn" onclick="clearLog()">L√∂schen</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-entry info">
                        <div class="log-time">--:--:--</div>
                        <div class="log-message">BusBot bereit. Starten Sie einen Scan.</div>
                    </div>
                </div>
            </div>

        </div><!-- End app-layout -->
    </div>

    <script>
        const API_BASE = window.location.pathname.replace(/\/$/, '');
        let autoScanTimer = null;
        let progressTimer = null;
        let selectedDevice = null;
        let networkDevices = [];
        let busDevices = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadNetworkInfo();
            loadExistingDevices();

            // Auto-scan toggle
            document.getElementById('autoScanEnabled').addEventListener('change', toggleAutoScan);
        });

        // Load network info
        async function loadNetworkInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/network-info`);
                const info = await response.json();

                document.getElementById('infoIP').textContent = info.ip || '-';
                document.getElementById('infoNetmask').textContent = info.netmask || '-';
                document.getElementById('infoGateway').textContent = info.gateway || '-';
                document.getElementById('infoDNS').textContent = info.dns || '-';

                // Auto-fill network range
                if (info.scan_range) {
                    document.getElementById('networkRange').placeholder = info.scan_range;
                }
            } catch (error) {
                console.error('Error loading network info:', error);
            }
        }

        // Load existing devices from previous scans
        async function loadExistingDevices() {
            try {
                const [netRes, busRes] = await Promise.all([
                    fetch(`${API_BASE}/api/scan/network-devices`),
                    fetch(`${API_BASE}/api/scan/bus-devices`)
                ]);

                const netData = await netRes.json();
                const busData = await busRes.json();

                if (netData.devices && netData.devices.length > 0) {
                    networkDevices = netData.devices;
                    displayNetworkDevices();
                }

                if (busData.devices && busData.devices.length > 0) {
                    busDevices = busData.devices;
                    displayBusDevices();
                }
            } catch (error) {
                console.error('Error loading existing devices:', error);
            }
        }

        // Show alert - adds to log panel
        function showAlert(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('de-DE');

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <div class="log-time">${timeStr}</div>
                <div class="log-message">${message}</div>
            `;

            // Add to top of log
            logContent.insertBefore(logEntry, logContent.firstChild);

            // Keep maximum 100 entries
            while (logContent.children.length > 100) {
                logContent.removeChild(logContent.lastChild);
            }
        }

        // Clear log
        function clearLog() {
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = `
                <div class="log-entry info">
                    <div class="log-time">${new Date().toLocaleTimeString('de-DE')}</div>
                    <div class="log-message">Log gel√∂scht.</div>
                </div>
            `;
        }

        // Start full two-phase scan
        async function startFullScan() {
            const network = document.getElementById('networkRange').value || null;
            const portRange = document.getElementById('portRange').value || '102,502,510';

            document.getElementById('btnScan').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('progressArea').classList.add('active');

            showAlert('Scan gestartet...', 'info');

            // Start progress polling
            startProgressPolling();

            try {
                const response = await fetch(`${API_BASE}/api/scan/full`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        network: network,
                        port_range: portRange,
                        auto_add: false
                    })
                });

                const result = await response.json();

                stopProgressPolling();
                document.getElementById('progressArea').classList.remove('active');
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnStop').disabled = true;

                if (result.success) {
                    networkDevices = result.network_devices || [];
                    busDevices = result.bus_devices || [];

                    displayNetworkDevices();
                    displayBusDevices();

                    showAlert(`Scan abgeschlossen: ${networkDevices.length} Netzwerk-Ger√§te, ${busDevices.length} Bus-Ger√§te`, 'success');
                } else {
                    showAlert('Fehler: ' + (result.error || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                stopProgressPolling();
                document.getElementById('progressArea').classList.remove('active');
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnStop').disabled = true;
                showAlert('Scan-Fehler: ' + error.message, 'error');
            }
        }

        // Stop scan
        function stopScan() {
            stopProgressPolling();
            document.getElementById('progressArea').classList.remove('active');
            document.getElementById('btnScan').disabled = false;
            document.getElementById('btnStop').disabled = true;
            showAlert('Scan gestoppt', 'info');
        }

        // Progress polling
        function startProgressPolling() {
            progressTimer = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/scan-progress`);
                    const status = await response.json();

                    if (status.active) {
                        // Update phase
                        let phaseText = 'Scan l√§uft...';
                        if (status.phase === 'phase1_ping') {
                            phaseText = 'Phase 1: Ping-Scan (Netzwerk-Ger√§te finden)';
                        } else if (status.phase === 'phase2_ports') {
                            phaseText = 'Phase 2: Port-Scan (Bus-Protokolle erkennen)';
                        }
                        document.getElementById('progressPhase').textContent = phaseText;

                        // Update progress bar
                        const percent = status.progress_percent || 0;
                        document.getElementById('progressBar').style.width = percent + '%';
                        document.getElementById('progressBar').textContent = percent + '%';

                        // Update stats
                        document.getElementById('progressIP').textContent = status.current_ip || '-';
                        document.getElementById('progressScanned').textContent = status.scanned_hosts || 0;
                        document.getElementById('progressTotal').textContent = status.total_hosts || 254;
                        document.getElementById('progressFound').textContent = status.found_devices || 0;

                        // ETA
                        if (status.eta_seconds > 0) {
                            const mins = Math.floor(status.eta_seconds / 60);
                            const secs = status.eta_seconds % 60;
                            document.getElementById('progressETA').textContent =
                                `${mins}:${secs.toString().padStart(2, '0')}`;
                        }
                    }
                } catch (e) {
                    console.error('Progress poll error:', e);
                }
            }, 500);
        }

        function stopProgressPolling() {
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        // Display network devices
        function displayNetworkDevices() {
            const list = document.getElementById('networkDeviceList');
            document.getElementById('networkCount').textContent = networkDevices.length;

            if (networkDevices.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div>Keine Ger√§te gefunden</div>
                    </div>`;
                return;
            }

            list.innerHTML = networkDevices.map(device => `
                <div class="device-item">
                    <div class="device-ip">${device.ip}</div>
                    <div class="device-details">
                        <div class="device-detail">
                            <span class="device-detail-label">MAC:</span>
                            <span>${device.mac || 'Unknown'}</span>
                        </div>
                        <div class="device-detail">
                            <span class="device-detail-label">Hersteller:</span>
                            <span>${device.vendor || 'Unknown'}</span>
                        </div>
                        ${device.hostname ? `
                        <div class="device-detail">
                            <span class="device-detail-label">Host:</span>
                            <span>${device.hostname}</span>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Display bus devices
        function displayBusDevices() {
            const list = document.getElementById('busDeviceList');
            document.getElementById('busCount').textContent = busDevices.length;

            if (busDevices.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div>Keine Bus-Ger√§te gefunden</div>
                    </div>`;
                return;
            }

            list.innerHTML = busDevices.map((device, index) => {
                const protocolClass = device.protocol === 'S7comm' ? 's7comm' : 'modbus';
                return `
                <div class="device-item bus-device" onclick="selectBusDevice(${index})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="device-ip">${device.ip}:${device.port}</div>
                            <div class="device-details">
                                <div class="device-detail">
                                    <span class="protocol-badge ${protocolClass}">${device.protocol}</span>
                                </div>
                                <div class="device-detail">
                                    <span class="device-detail-label">MAC:</span>
                                    <span>${device.mac || 'Unknown'}</span>
                                </div>
                                <div class="device-detail">
                                    <span class="device-detail-label">Hersteller:</span>
                                    <span>${device.vendor || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-configure" onclick="event.stopPropagation(); configureDevice(${index})">
                            ‚öôÔ∏è Config
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // Select bus device for configuration
        function selectBusDevice(index) {
            selectedDevice = busDevices[index];
            fillConfigForm(selectedDevice);
            updateNoteField();
            showAlert(`Ger√§t ${selectedDevice.ip}:${selectedDevice.port} ausgew√§hlt`, 'info');
        }

        // Fill configuration form with device data
        function fillConfigForm(device) {
            if (!device) return;

            // Generate default name
            const vendorPart = device.vendor ? device.vendor.split(' ')[0] : 'Device';
            const ipPart = device.ip.split('.').pop();
            document.getElementById('cfgName').value = `${vendorPart}_${ipPart}`;

            // Set protocol
            const protocolSelect = document.getElementById('cfgProtocol');
            if (device.protocol === 'S7comm') {
                protocolSelect.value = 's7comm';
            } else if (device.protocol && device.protocol.includes('Modbus')) {
                protocolSelect.value = 'modbus_tcp';
            } else {
                protocolSelect.value = 'modbus_tcp';
            }

            document.getElementById('cfgIP').value = device.ip;
            document.getElementById('cfgPort').value = device.port || 502;
            document.getElementById('cfgSlaveId').value = device.slave_id || 1;
            document.getElementById('cfgManufacturer').value = device.vendor || '';
            document.getElementById('cfgRegStart').value = '';
            document.getElementById('cfgRegCount').value = '';
        }

        // Configure device (analyze registers)
        async function configureDevice(index) {
            const device = busDevices[index];
            selectedDevice = device;
            fillConfigForm(device);

            showAlert(`Analysiere ${device.ip}:${device.port}...`, 'info');

            // Try to discover registers
            try {
                const response = await fetch(`${API_BASE}/api/discover-registers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        host: device.ip,
                        port: device.port,
                        slave_id: 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    selectedDevice.registers = result;
                    showAlert('Register-Analyse abgeschlossen', 'success');
                } else {
                    showAlert('Register-Analyse: ' + (result.error || 'Keine Register gefunden'), 'warning');
                }
            } catch (error) {
                console.error('Register discovery error:', error);
                showAlert('Fehler bei Register-Analyse', 'error');
            }

            updateNoteField();
        }

        // Save device configuration
        async function saveDeviceConfig() {
            const name = document.getElementById('cfgName').value;
            const ip = document.getElementById('cfgIP').value;
            const port = document.getElementById('cfgPort').value;
            const slaveId = document.getElementById('cfgSlaveId').value;
            const manufacturer = document.getElementById('cfgManufacturer').value;
            const protocol = document.getElementById('cfgProtocol').value;

            if (!name || !ip) {
                showAlert('Ger√§tename und IP-Adresse sind erforderlich', 'error');
                return;
            }

            showAlert(`Speichere ${name}...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/api/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        manufacturer: manufacturer || 'Generic',
                        model: protocol === 's7comm' ? 'S7comm' : 'Modbus TCP',
                        host: ip,
                        port: parseInt(port) || 502,
                        slave_id: parseInt(slaveId) || 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`Ger√§t "${name}" gespeichert`, 'success');
                } else {
                    showAlert('Fehler: ' + (result.error || 'Speichern fehlgeschlagen'), 'error');
                }
            } catch (error) {
                showAlert('Fehler: ' + error.message, 'error');
            }
        }

        // Update note field with device info
        function updateNoteField() {
            const noteField = document.getElementById('noteField');

            if (!selectedDevice) {
                noteField.textContent = 'Kein Ger√§t ausgew√§hlt.';
                return;
            }

            let content = `GER√ÑTEINFORMATIONEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
IP-Adresse:    ${selectedDevice.ip}
Port:          ${selectedDevice.port}
Protokoll:     ${selectedDevice.protocol}
MAC-Adresse:   ${selectedDevice.mac || 'Unbekannt'}
Hersteller:    ${selectedDevice.vendor || 'Unbekannt'}
`;

            if (selectedDevice.registers) {
                const reg = selectedDevice.registers;
                content += `
ERKANNTES GER√ÑT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Typ:           ${reg.detected_device || 'Unbekannt'}

UNTERST√úTZTE FUNKTIONEN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${reg.supported_functions ? reg.supported_functions.join('\n') : 'Keine erkannt'}

`;
                if (reg.register_ranges) {
                    content += `REGISTER-BEREICHE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
                    if (reg.register_ranges.discrete_inputs) {
                        const di = reg.register_ranges.discrete_inputs.filter(r => r.supported);
                        if (di.length > 0) {
                            content += `\nDigital Inputs:  ${di.map(r => r.range).join(', ')}`;
                        }
                    }
                    if (reg.register_ranges.coils) {
                        const co = reg.register_ranges.coils.filter(r => r.supported);
                        if (co.length > 0) {
                            content += `\nDigital Outputs: ${co.map(r => r.range).join(', ')}`;
                        }
                    }
                    if (reg.register_ranges.input_registers) {
                        const ir = reg.register_ranges.input_registers.filter(r => r.supported);
                        if (ir.length > 0) {
                            content += `\nAnalog Inputs:   ${ir.map(r => r.range).join(', ')}`;
                        }
                    }
                    if (reg.register_ranges.holding_registers) {
                        const hr = reg.register_ranges.holding_registers.filter(r => r.supported);
                        if (hr.length > 0) {
                            content += `\nHolding Regs:    ${hr.map(r => r.range).join(', ')}`;
                        }
                    }
                }
            }

            noteField.textContent = content;
        }

        // Generate Modbus config from form
        async function generateModbusConfig() {
            const name = document.getElementById('cfgName').value;
            const ip = document.getElementById('cfgIP').value;
            const port = document.getElementById('cfgPort').value;
            const slaveId = document.getElementById('cfgSlaveId').value;
            const manufacturer = document.getElementById('cfgManufacturer').value;
            const regStart = document.getElementById('cfgRegStart').value;
            const regCount = document.getElementById('cfgRegCount').value;

            if (!ip) {
                showAlert('IP-Adresse ist erforderlich', 'error');
                return;
            }

            showAlert('Generiere Modbus-Konfiguration...', 'info');

            // First save the current config to device list
            try {
                await fetch(`${API_BASE}/api/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || `Device_${ip.split('.').pop()}`,
                        manufacturer: manufacturer || 'Generic',
                        model: 'Modbus TCP',
                        host: ip,
                        port: parseInt(port) || 502,
                        slave_id: parseInt(slaveId) || 1,
                        register_start: regStart ? parseInt(regStart) : undefined,
                        register_count: regCount ? parseInt(regCount) : undefined
                    })
                });
            } catch (e) {
                console.error('Error adding device:', e);
            }

            // Then generate YAML config
            try {
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_scan: false })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`YAML generiert: ${result.path}`, 'success');
                } else {
                    showAlert('Fehler: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Fehler: ' + error.message, 'error');
            }
        }

        // Generate S7 config
        function generateS7Config() {
            const protocol = document.getElementById('cfgProtocol').value;
            if (protocol !== 's7comm') {
                showAlert('Bitte S7comm als Protokoll w√§hlen', 'warning');
                return;
            }
            showAlert('S7comm-Konfiguration wird noch implementiert...', 'info');
        }

        // View config
        async function viewConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const result = await response.json();

                if (result.success) {
                    const win = window.open('', '_blank');
                    win.document.write(`
                        <html>
                        <head><title>Konfiguration</title>
                        <style>body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #4caf50; }
                        pre { white-space: pre-wrap; }</style></head>
                        <body><h1>Modbus-Konfiguration</h1><pre>${result.config}</pre></body>
                        </html>
                    `);
                } else {
                    showAlert('Keine Konfiguration gefunden', 'error');
                }
            } catch (error) {
                showAlert('Fehler: ' + error.message, 'error');
            }
        }

        // Toggle auto-scan
        function toggleAutoScan() {
            const enabled = document.getElementById('autoScanEnabled').checked;
            const interval = parseInt(document.getElementById('scanInterval').value) || 5;

            if (enabled) {
                showAlert(`Auto-Scan aktiviert (alle ${interval} Minuten)`, 'success');
                autoScanTimer = setInterval(() => {
                    startFullScan();
                }, interval * 60 * 1000);

                // Start first scan immediately
                startFullScan();
            } else {
                if (autoScanTimer) {
                    clearInterval(autoScanTimer);
                    autoScanTimer = null;
                }
                showAlert('Auto-Scan deaktiviert', 'info');
            }
        }
    </script>
</body>
</html>
