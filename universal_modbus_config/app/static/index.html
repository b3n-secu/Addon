<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Modbus Configurator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button-secondary {
            background: #6c757d;
            color: white;
        }

        .button-secondary:hover {
            background: #5a6268;
        }

        .button-success {
            background: #28a745;
            color: white;
        }

        .button-success:hover {
            background: #218838;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .device-list {
            list-style: none;
        }

        .device-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .device-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .device-details {
            color: #666;
            font-size: 0.9em;
        }

        .device-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .scan-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .scan-results h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .scan-stat {
            display: inline-block;
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .scan-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .scan-stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Universal Modbus Configurator</h1>
            <p>Einfache Konfiguration von Modbus-Ger√§ten f√ºr Home Assistant</p>
        </div>

        <div class="content">
            <!-- Alert Area -->
            <div id="alertArea"></div>

            <!-- Network Scanner Section -->
            <div class="section">
                <h2 class="section-title">üîç Netzwerk-Scanner</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Scannt das lokale Netzwerk automatisch nach Modbus-Ger√§ten (Ports 502 und 510).
                </p>
                <button class="button button-primary" onclick="scanNetwork()">
                    üåê Netzwerk scannen
                </button>
                <div id="networkScanResults" class="hidden" style="margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Gefundene Ger√§te:</h3>
                    <div id="networkDeviceList"></div>
                </div>
            </div>

            <!-- Add Device Section -->
            <div class="section">
                <h2 class="section-title">Neues Ger√§t hinzuf√ºgen</h2>

                <form id="addDeviceForm">
                    <div class="grid">
                        <div class="form-group">
                            <label for="manufacturer">Hersteller</label>
                            <select id="manufacturer" required>
                                <option value="">-- W√§hlen --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="model">Modell</label>
                            <select id="model" required disabled>
                                <option value="">-- Erst Hersteller w√§hlen --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="deviceName">Ger√§tename</label>
                            <input type="text" id="deviceName" placeholder="z.B. Logo1_Haupthaus" required>
                        </div>

                        <div class="form-group">
                            <label for="host">IP-Adresse</label>
                            <input type="text" id="host" placeholder="192.168.1.100" required>
                        </div>

                        <div class="form-group">
                            <label for="port">Port</label>
                            <input type="number" id="port" placeholder="502" value="502">
                        </div>

                        <div class="form-group">
                            <label for="slaveId">Slave ID (optional)</label>
                            <input type="number" id="slaveId" placeholder="1" min="1" max="247">
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="button" class="button button-secondary" onclick="testConnection()">
                            Verbindung testen
                        </button>
                        <button type="button" class="button button-secondary" onclick="scanDevice()">
                            Ger√§t scannen
                        </button>
                        <button type="button" class="button button-success" onclick="scanLogo8()">
                            üîç LOGO! 8 Detaillierter Scan
                        </button>
                        <button type="submit" class="button button-primary">
                            Ger√§t hinzuf√ºgen
                        </button>
                    </div>
                </form>

                <div id="scanResults" class="scan-results hidden"></div>
            </div>

            <!-- Device List Section -->
            <div class="section">
                <h2 class="section-title">Konfigurierte Ger√§te</h2>
                <ul id="deviceList" class="device-list">
                    <li class="loading">
                        <div class="spinner"></div>
                        <p>Lade Ger√§te...</p>
                    </li>
                </ul>
            </div>

            <!-- Generate Config Section -->
            <div class="section">
                <h2 class="section-title">Konfiguration generieren</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Generiert eine modbus.yaml Datei f√ºr Home Assistant basierend auf den konfigurierten Ger√§ten.
                </p>
                <button class="button button-success" onclick="generateConfig()">
                    üìÑ Konfiguration generieren
                </button>
                <button class="button button-secondary" onclick="viewConfig()">
                    üëÅÔ∏è Aktuelle Konfiguration anzeigen
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentScanResults = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadManufacturers();
            loadDevices();

            document.getElementById('addDeviceForm').addEventListener('submit', addDevice);
            document.getElementById('manufacturer').addEventListener('change', onManufacturerChange);
            document.getElementById('model').addEventListener('change', onModelChange);
        });

        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertArea.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        async function loadManufacturers() {
            try {
                const response = await fetch(`${API_BASE}/api/manufacturers`);
                const manufacturers = await response.json();

                const select = document.getElementById('manufacturer');
                manufacturers.forEach(mfr => {
                    const option = document.createElement('option');
                    option.value = mfr;
                    option.textContent = mfr;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Fehler beim Laden der Hersteller: ' + error.message, 'error');
            }
        }

        async function onManufacturerChange(e) {
            const manufacturer = e.target.value;
            const modelSelect = document.getElementById('model');

            modelSelect.innerHTML = '<option value="">-- W√§hlen --</option>';
            modelSelect.disabled = !manufacturer;

            if (manufacturer) {
                try {
                    const response = await fetch(`${API_BASE}/api/models/${encodeURIComponent(manufacturer)}`);
                    const models = await response.json();

                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                } catch (error) {
                    showAlert('Fehler beim Laden der Modelle: ' + error.message, 'error');
                }
            }
        }

        async function onModelChange(e) {
            const manufacturer = document.getElementById('manufacturer').value;
            const model = e.target.value;

            if (manufacturer && model) {
                try {
                    const response = await fetch(`${API_BASE}/api/profile/${encodeURIComponent(manufacturer)}/${encodeURIComponent(model)}`);
                    const profile = await response.json();

                    if (profile.port) {
                        document.getElementById('port').value = profile.port;
                    }
                } catch (error) {
                    showAlert('Fehler beim Laden des Profils: ' + error.message, 'error');
                }
            }
        }

        async function testConnection() {
            const host = document.getElementById('host').value;
            const port = document.getElementById('port').value;

            if (!host) {
                showAlert('Bitte IP-Adresse eingeben', 'error');
                return;
            }

            showAlert('Teste Verbindung...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/test-connection`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ host, port: parseInt(port) })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úì Verbindung erfolgreich!', 'success');
                } else {
                    showAlert('‚úó Verbindung fehlgeschlagen: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('Fehler beim Testen der Verbindung: ' + error.message, 'error');
            }
        }

        async function scanDevice() {
            const host = document.getElementById('host').value;
            const port = document.getElementById('port').value;
            const manufacturer = document.getElementById('manufacturer').value;
            const model = document.getElementById('model').value;
            const slaveId = document.getElementById('slaveId').value;

            if (!host) {
                showAlert('Bitte IP-Adresse eingeben', 'error');
                return;
            }

            showAlert('Scanne Ger√§t...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/scan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        host,
                        port: parseInt(port),
                        manufacturer,
                        model,
                        slave_id: slaveId ? parseInt(slaveId) : 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentScanResults = result.results;
                    displayScanResults(result);
                    showAlert(`‚úì Scan erfolgreich! ${result.total} Register gefunden.`, 'success');
                } else {
                    showAlert('‚úó Scan fehlgeschlagen: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('Fehler beim Scannen: ' + error.message, 'error');
            }
        }

        function displayScanResults(result) {
            const resultsDiv = document.getElementById('scanResults');
            resultsDiv.classList.remove('hidden');

            resultsDiv.innerHTML = `
                <h4>Scan Ergebnisse:</h4>
                <div>
                    <div class="scan-stat">
                        <div class="scan-stat-label">Input Register</div>
                        <div class="scan-stat-value">${result.results.input_registers.length}</div>
                    </div>
                    <div class="scan-stat">
                        <div class="scan-stat-label">Holding Register</div>
                        <div class="scan-stat-value">${result.results.holding_registers.length}</div>
                    </div>
                    <div class="scan-stat">
                        <div class="scan-stat-label">Discrete Inputs</div>
                        <div class="scan-stat-value">${result.results.discrete_inputs.length}</div>
                    </div>
                    <div class="scan-stat">
                        <div class="scan-stat-label">Coils</div>
                        <div class="scan-stat-value">${result.results.coils.length}</div>
                    </div>
                    <div class="scan-stat">
                        <div class="scan-stat-label">Gesamt</div>
                        <div class="scan-stat-value">${result.total}</div>
                    </div>
                </div>
            `;
        }

        async function scanLogo8() {
            const host = document.getElementById('host').value;
            const port = document.getElementById('port').value;
            const slaveId = document.getElementById('slaveId').value;

            if (!host) {
                showAlert('Bitte IP-Adresse eingeben', 'error');
                return;
            }

            showAlert('Starte detaillierten LOGO! 8 Scan...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/scan-logo8`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        host,
                        port: parseInt(port),
                        slave_id: slaveId ? parseInt(slaveId) : 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayLogo8ScanResults(result);
                    showAlert(`‚úì LOGO! 8 Scan erfolgreich! ${result.total} Adressen gefunden.`, 'success');
                } else {
                    showAlert('‚úó Scan fehlgeschlagen: ' + (result.error || result.message), 'error');
                }
            } catch (error) {
                showAlert('Fehler beim LOGO! 8 Scan: ' + error.message, 'error');
            }
        }

        function displayLogo8ScanResults(result) {
            const resultsDiv = document.getElementById('scanResults');
            resultsDiv.classList.remove('hidden');

            let html = '<h4>LOGO! 8 Detaillierte Scan Ergebnisse:</h4>';

            // Statistics
            html += '<div style="margin-bottom: 20px;">';
            html += `<div class="scan-stat">
                <div class="scan-stat-label">Digital Inputs</div>
                <div class="scan-stat-value">${result.results.digital_inputs.length}</div>
            </div>`;
            html += `<div class="scan-stat">
                <div class="scan-stat-label">Digital Outputs</div>
                <div class="scan-stat-value">${result.results.digital_outputs.length}</div>
            </div>`;
            html += `<div class="scan-stat">
                <div class="scan-stat-label">Analog Inputs</div>
                <div class="scan-stat-value">${result.results.analog_inputs.length}</div>
            </div>`;
            html += `<div class="scan-stat">
                <div class="scan-stat-label">Analog Outputs</div>
                <div class="scan-stat-value">${result.results.analog_outputs.length}</div>
            </div>`;
            html += `<div class="scan-stat">
                <div class="scan-stat-label">VM Memory</div>
                <div class="scan-stat-value">${result.results.vm_memory.length}</div>
            </div>`;
            html += `<div class="scan-stat">
                <div class="scan-stat-label">Gesamt</div>
                <div class="scan-stat-value">${result.total}</div>
            </div>`;
            html += '</div>';

            // Detailed address list
            html += '<div style="max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px;">';

            // Digital Inputs
            if (result.results.digital_inputs.length > 0) {
                html += '<h5 style="color: #667eea; margin-top: 0;">Digital Inputs (DI):</h5>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Name</th><th>Adresse</th><th>Modbus Addr</th><th>Wert</th></tr>';
                result.results.digital_inputs.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="text-align: center;">${item.address}</td>
                        <td style="text-align: center;">${item.modbus_address}</td>
                        <td style="text-align: center;">${item.value ? '‚úì ON' : '‚úó OFF'}</td>
                    </tr>`;
                });
                html += '</table>';
            }

            // Digital Outputs
            if (result.results.digital_outputs.length > 0) {
                html += '<h5 style="color: #667eea;">Digital Outputs (Q):</h5>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Name</th><th>Adresse</th><th>Modbus Addr</th><th>Wert</th></tr>';
                result.results.digital_outputs.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="text-align: center;">${item.address}</td>
                        <td style="text-align: center;">${item.modbus_address}</td>
                        <td style="text-align: center;">${item.value ? '‚úì ON' : '‚úó OFF'}</td>
                    </tr>`;
                });
                html += '</table>';
            }

            // Analog Inputs
            if (result.results.analog_inputs.length > 0) {
                html += '<h5 style="color: #667eea;">Analog Inputs (AI):</h5>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Name</th><th>Adresse</th><th>Modbus Addr</th><th>Wert</th><th>Methode</th></tr>';
                result.results.analog_inputs.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="text-align: center;">${item.address}</td>
                        <td style="text-align: center;">${item.modbus_address}</td>
                        <td style="text-align: center;">${item.value}</td>
                        <td style="text-align: center;">${item.method || '-'}</td>
                    </tr>`;
                });
                html += '</table>';
            }

            // Analog Outputs
            if (result.results.analog_outputs.length > 0) {
                html += '<h5 style="color: #667eea;">Analog Outputs (AQ):</h5>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Name</th><th>Adresse</th><th>Modbus Addr</th><th>Wert</th></tr>';
                result.results.analog_outputs.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="text-align: center;">${item.address}</td>
                        <td style="text-align: center;">${item.modbus_address}</td>
                        <td style="text-align: center;">${item.value}</td>
                    </tr>`;
                });
                html += '</table>';
            }

            // VM Memory
            if (result.results.vm_memory.length > 0) {
                html += '<h5 style="color: #667eea;">VM Memory (VW):</h5>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Name</th><th>Adresse</th><th>Modbus Addr</th><th>Wert</th></tr>';
                result.results.vm_memory.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="text-align: center;">${item.address}</td>
                        <td style="text-align: center;">${item.modbus_address}</td>
                        <td style="text-align: center;">${item.value}</td>
                    </tr>`;
                });
                html += '</table>';
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function addDevice(e) {
            e.preventDefault();

            const device = {
                manufacturer: document.getElementById('manufacturer').value,
                model: document.getElementById('model').value,
                name: document.getElementById('deviceName').value,
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                slave_id: document.getElementById('slaveId').value ? parseInt(document.getElementById('slaveId').value) : null
            };

            try {
                const response = await fetch(`${API_BASE}/api/devices`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(device)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úì Ger√§t erfolgreich hinzugef√ºgt!', 'success');
                    document.getElementById('addDeviceForm').reset();
                    document.getElementById('scanResults').classList.add('hidden');
                    loadDevices();
                } else {
                    showAlert('‚úó Fehler: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Fehler beim Hinzuf√ºgen: ' + error.message, 'error');
            }
        }

        async function loadDevices() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '<li class="loading"><div class="spinner"></div><p>Lade Ger√§te...</p></li>';

            try {
                const response = await fetch(`${API_BASE}/api/devices`);
                const devices = await response.json();

                if (devices.length === 0) {
                    deviceList.innerHTML = '<li style="text-align: center; padding: 20px; color: #666;">Keine Ger√§te konfiguriert</li>';
                    return;
                }

                deviceList.innerHTML = '';
                devices.forEach((device, index) => {
                    const li = document.createElement('li');
                    li.className = 'device-item';
                    li.innerHTML = `
                        <div class="device-info">
                            <div class="device-name">${device.name}</div>
                            <div class="device-details">
                                ${device.manufacturer} ${device.model} | ${device.host}:${device.port}
                                ${device.slave_id ? ` | Slave: ${device.slave_id}` : ''}
                            </div>
                        </div>
                        <div class="device-actions">
                            <button class="button button-danger" onclick="deleteDevice(${index})">L√∂schen</button>
                        </div>
                    `;
                    deviceList.appendChild(li);
                });
            } catch (error) {
                deviceList.innerHTML = '<li style="text-align: center; padding: 20px; color: #dc3545;">Fehler beim Laden der Ger√§te</li>';
                showAlert('Fehler beim Laden der Ger√§te: ' + error.message, 'error');
            }
        }

        async function deleteDevice(index) {
            if (!confirm('M√∂chten Sie dieses Ger√§t wirklich l√∂schen?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/devices/${index}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úì Ger√§t gel√∂scht', 'success');
                    loadDevices();
                } else {
                    showAlert('‚úó Fehler: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Fehler beim L√∂schen: ' + error.message, 'error');
            }
        }

        async function generateConfig() {
            showAlert('Generiere Konfiguration...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ include_scan: false })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úì Konfiguration erfolgreich generiert!\nPfad: ${result.path}`, 'success');
                } else {
                    showAlert('‚úó Fehler: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Fehler beim Generieren: ' + error.message, 'error');
            }
        }

        async function viewConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const result = await response.json();

                if (result.success) {
                    const win = window.open('', '_blank');
                    win.document.write(`
                        <html>
                        <head>
                            <title>Modbus Konfiguration</title>
                            <style>
                                body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                                pre { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                            </style>
                        </head>
                        <body>
                            <h1>Modbus Konfiguration</h1>
                            <pre>${result.config}</pre>
                        </body>
                        </html>
                    `);
                } else {
                    showAlert('Keine Konfiguration gefunden. Bitte erst generieren.', 'error');
                }
            } catch (error) {
                showAlert('Fehler beim Laden der Konfiguration: ' + error.message, 'error');
            }
        }

        async function scanNetwork() {
            const resultsDiv = document.getElementById('networkScanResults');
            const deviceListDiv = document.getElementById('networkDeviceList');

            resultsDiv.classList.remove('hidden');
            deviceListDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Scanne Netzwerk nach Modbus-Ger√§ten...</p></div>';

            showAlert('Netzwerk-Scan gestartet... Dies kann einige Minuten dauern.', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/scan-network`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success && result.devices.length > 0) {
                    showAlert(`‚úì Scan abgeschlossen! ${result.total} Ger√§t(e) gefunden.`, 'success');
                    displayNetworkDevices(result.devices);
                } else if (result.success && result.devices.length === 0) {
                    deviceListDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Keine Modbus-Ger√§te gefunden.</div>';
                    showAlert('Scan abgeschlossen. Keine Ger√§te gefunden.', 'info');
                } else {
                    deviceListDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Fehler beim Scannen</div>';
                    showAlert('‚úó Fehler beim Scannen: ' + result.error, 'error');
                }
            } catch (error) {
                deviceListDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Fehler beim Scannen</div>';
                showAlert('Fehler beim Netzwerk-Scan: ' + error.message, 'error');
            }
        }

        function displayNetworkDevices(devices) {
            const deviceListDiv = document.getElementById('networkDeviceList');
            deviceListDiv.innerHTML = '';

            devices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-item';
                deviceCard.style.cursor = 'pointer';
                deviceCard.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">üåê ${device.ip}:${device.port}</div>
                        <div class="device-details">
                            Status: ${device.status === 'online' ? '‚úì Online' : '‚úó Offline'}
                        </div>
                    </div>
                    <div class="device-actions">
                        <button class="button button-primary" onclick="useDiscoveredDevice('${device.ip}', ${device.port})">
                            Verwenden
                        </button>
                    </div>
                `;
                deviceListDiv.appendChild(deviceCard);
            });
        }

        function useDiscoveredDevice(ip, port) {
            document.getElementById('host').value = ip;
            document.getElementById('port').value = port;

            // Scroll to the add device form
            document.getElementById('addDeviceForm').scrollIntoView({ behavior: 'smooth', block: 'start' });

            showAlert(`IP-Adresse ${ip}:${port} wurde in das Formular √ºbernommen.`, 'success');
        }
    </script>
</body>
</html>
